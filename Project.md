# YOYOJ-GO-RAG

简单易用的私有化知识库和内容生成系统。

---

# 1. 项目概述

本项目将专注于使用外接 AI 模型，使用 GO 语言和 fiber 后端开发框架构建 RAG 私有知识库系统。主要面对的是持久化记忆存储和知识问答的场景。知识输入端由文档、网页、图片组成。涉及多模态、OCR、Agent 设计。

目前市面上诸多基于 python 等亲和 AI 的语言项目实现RAG 系统，当然 Go 语言方面也开始有很多 RAG 项目诞生。本项目核心目的虽不可避免与其他工具竞争，但核心目的是借由 GO 语言的构建部署、并发优势进行 AI 产品思考，同时也是作者学习和组织 GO 后端项目的契机，深度学习思考和拓展 AI 和新后端开发语言上的产品设计和技术积累。

# 2. MVP 技术业务设计

目标场景：企业/家庭 组织共享知识体系，实现 AI 集成。



## 2.1 用户

1. 所有用户经由统一的登入入口进入，区分用户的角色类型
2. 管理员可以给不同用户分配权限。此功能作为 RAG 范围边界，只有有权访问的内容会被作为回答参考
3. 支持普通用户多端多点登录，管理员单点登录。
4. 权限被变更的用户能收到系统通知。
5. 支持邮箱登录。手机号登录预留作为身份实名信息之一。
6. 用户实名功能。用户可以主动添加实名信息以作为管理员操作用户时的参考信息。
7. 支持管理员管控注册开放状态。支持“完全开放”、“禁用”、“需要审核”三种状态。用户审核记录持久保留可以查询。
8. 用户注册仅需要邮箱验证即可，支持使用密码和验证码两种方式进行登录。
9. 单个用户验证码发送频率间隔为 1min。不同邮箱不共享 1 分钟限制。
10. 管理员配置和提供模型的 endpoint 和 api_key



## 2.2 知识库

1. 管理员有权查看所有的知识库。
2. 所有人均可创建独立的知识库。知识库有两种类型：公共、私有。私有的解释是对白名单内人员开放，白名单默认添加创建人，创建人不能从白名单中移除自己，如果移除意味着删除，但可以转让知识库。
3. 知识库创建人可以访问知识库下的所有文档。
4. 知识库内只有文档，没有目录的概念，但是文档之间可以形成树形关系。理论上可以无限创建子文档。
5. 文档可以被关注。关注人会收到文档动态信息。文档支持直接打开。
6. 上传的文档默认作为知识库的物料，但是也可以取消文本 embedding 执行保存功能，支持后续在执行 embedding 操作和重新 embedding 操作。*这里需要考虑向量数据库的旧数据删除功能问题。*
7. 支持 pdf、word、markdown 文档内容上传，支持图片上传，图片在此 MVP 阶段不参与 Embedding，但是可以被用户标记 tag。
8. 文档支持手动添加 tag，默认会在 Embedding 的时候生成对应的 tag 保存。
9. 支持网页链接作为内容提供 embedding。网页链接添加后也是和上传文件一样处理。支持后续重新 embedding。



## 2.3 AI对话

1. 支持历史消息列表
2. 支持记忆单词 session 中的一定量的上下文。
3. 目前阶段可以不做长期记忆。
4. 支持动态切换模型。
5. 支持临时添加文件作为参考。采用多 Agent/Tool 模式解析。添加到上下文。
6. 对话可以随时停止。
7. 支持 markdown 渲染预览。
8. （可选）支持 MCP 功能。支持用户定义工具列表。用户可以定义和维护自己的 Agent 策略，其中包含 MCP 插件、模型名称，提示词。应用策略的时候需要校验模型和插件的可用性，如果插件不可用则需要进行提示和标红，并给出修改策略——使用默认策略。



## 2.4 统计

1. 管理员可以看到服务整体/单个用户的 token 用量，文件被提及、访问、关注的统计，系统被访问和使用的热力图。token 用量提供 日、周、月、年视图
2. 普通用户可以看自己的 token 用量统计。

## 2.5 通知

1. 支持系统通知。
2. 支持一键已读。
3. （管理员）支持系统消息已读数量统计和人员展示。
4. 支持邮件通知。



# 3. 领域设计概况

## 核心领域划分

### 1. **用户与权限域 (User & Permission Domain)**

**核心职责**: 身份认证、授权、用户生命周期管理

**聚合根**:

- `User`: 用户实体(包含邮箱、实名信息、角色)
- `Session`: 会话管理(多点登录控制)

**值对象**:

- `Email`, `Phone`, `RealNameInfo`
- `Role` (管理员/普通用户)
- `RegistrationPolicy` (开放/禁用/审核)

**领域服务**:

- `AuthenticationService`: 验证码、密码登录
- `AuthorizationService`: 权限检查
- `RegistrationService`: 注册审核流程

**边界**:

- 对外提供用户身份验证和权限查询接口
- 不关心具体业务资源(知识库、文档)的细节

------

### 2. **知识库域 (Knowledge Base Domain)**

**核心职责**: 知识组织、文档管理、访问控制

**聚合根**:

- `KnowledgeBase`: 知识库(类型、白名单、所有权)
- `Document`: 文档(树形关系、标签、embedding状态)

**值对象**:

- `KnowledgeBaseType` (公共/私有)
- `DocumentMetadata` (标签、关注状态、文件类型)
- `EmbeddingStatus` (未处理/已处理/待重新处理)

**领域服务**:

- `AccessControlService`: 基于白名单的访问控制
- `DocumentRelationService`: 文档树形关系维护
- `DocumentFollowService`: 文档关注功能

**边界**:

- 管理知识的组织结构和访问权限
- 不处理内容解析和向量化(委托给内容处理域)

------

### 3. **内容处理域 (Content Processing Domain)**

**核心职责**: 文档解析、向量化、标签生成

**聚合根**:

- `DocumentContent`: 原始内容和解析结果
- `VectorData`: 向量数据和元信息

**值对象**:

- `FileType` (PDF/Word/Markdown/Image/WebPage)
- `ParsedContent`: 解析后的文本
- `EmbeddingVector`: 向量表示
- `AutoGeneratedTag`: AI生成的标签

**领域服务**:

- `FileParserService`: 多格式文件解析
- `WebScraperService`: 网页内容抓取
- `EmbeddingService`: 调用外部模型生成向量
- `TagGeneratorService`: 自动标签生成

**边界**:

- 处理所有内容输入和向量化
- 向量数据的生命周期管理(删除旧数据)

------

### 4. **对话域 (Conversation Domain)**

**核心职责**: AI对话、上下文管理、RAG检索

**聚合根**:

- `ConversationSession`: 对话会话
- `Message`: 消息(用户/AI消息、附件)

**值对象**:

- `Context`: 会话上下文(历史消息、token计数)
- `ModelConfig`: 模型配置
- `TemporaryReference`: 临时文件引用
- `AgentStrategy`: Agent策略配置(可选MCP)

**领域服务**:

- `RAGService`: 检索增强生成
- `ContextManagementService`: 上下文窗口管理
- `ModelInvocationService`: 调用外部AI模型
- `AgentOrchestrationService`: 多Agent协调(可选)

**边界**:

- 管理对话流程和AI交互
- 依赖知识库域查询用户权限内的内容
- 依赖内容处理域进行向量检索

------

### 5. **统计域 (Analytics Domain)**

**核心职责**: 使用数据收集、统计分析

**聚合根**:

- `UsageRecord`: 使用记录(token消耗、访问记录)

**值对象**:

- `TokenUsage`: token用量统计
- `DocumentStats`: 文档统计(访问、关注、提及)
- `HeatmapData`: 热力图数据

**领域服务**:

- `UsageTrackingService`: 使用追踪
- `StatisticsAggregationService`: 统计聚合

**边界**:

- 被动收集其他域的事件
- 提供只读查询接口

------

### 6. **通知域 (Notification Domain)**

**核心职责**: 消息通知、已读管理

**聚合根**:

- `Notification`: 通知实体

**值对象**:

- `NotificationType`: 通知类型(系统/权限变更/文档动态)
- `NotificationStatus`: 已读/未读

**领域服务**:

- `NotificationDispatchService`: 通知分发(站内/邮件)
- `EmailService`: 邮件发送

**边界**:

- 响应其他域的领域事件
- 独立的通知生命周期管理

------

## 关键设计考虑

### 依赖关系:

```
对话域 → 知识库域 → 用户域
     ↓          ↓
  内容处理域 ←────┘
     ↓
  统计域 ← 所有域(通过事件)
     ↓
  通知域 ← 所有域(通过事件)
```

### 跨域通信:

- 使用**领域事件**实现松耦合(如 `DocumentUploadedEvent`, `PermissionChangedEvent`)
- **防腐层**隔离外部依赖(向量数据库、AI模型、邮件服务)
- **共享内核**仅限基础类型(UserID、DocumentID等)

### 技术边界:

- 每个域可独立选择存储方案(关系型/向量/时序数据库)
- 清晰的API边界便于未来微服务拆分

这种划分既符合业务语义,又保持了技术上的灵活性和可扩展性。

